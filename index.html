<script>
  function detectAndEmbed(text) {
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    const frag = document.createDocumentFragment();
    let lastIndex = 0;
    let match;

    while ((match = urlRegex.exec(text)) !== null) {
      if (match.index > lastIndex) {
        frag.appendChild(document.createTextNode(text.slice(lastIndex, match.index)));
      }
      const url = match[0];
      let embedEl;

      // Détection image
      if (/\.(jpeg|jpg|gif|png|webp|svg)$/i.test(url)) {
        embedEl = document.createElement("div");
        embedEl.style.marginTop = "6px";
        const a = document.createElement("a");
        a.href = url;
        a.target = "_blank";
        const img = document.createElement("img");
        img.src = url;
        img.style.maxWidth = "240px";
        img.style.borderRadius = "6px";
        img.style.display = "block";
        img.style.marginTop = "4px";
        a.appendChild(img);
        embedEl.appendChild(a);
        frag.appendChild(embedEl);
      }
      // Détection vidéo YouTube
      else if (/^https?:\/\/(www\.)?youtube\.com\/watch\?v=/.test(url) || /^https?:\/\/youtu\.be\//.test(url)) {
        embedEl = document.createElement("iframe");
        embedEl.width = "300";
        embedEl.height = "180";
        embedEl.src = url.replace("watch?v=", "embed/").replace("youtu.be/", "youtube.com/embed/");
        embedEl.frameBorder = "0";
        embedEl.allow =
          "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
        embedEl.allowFullscreen = true;
        embedEl.style.marginTop = "6px";
        frag.appendChild(embedEl);
      }
      // Sinon : hyperlien simple
      else {
        const a = document.createElement("a");
        a.href = url;
        a.textContent = url;
        a.target = "_blank";
        a.style.color = "var(--accent)";
        frag.appendChild(a);
      }

      lastIndex = match.index + url.length;
    }
    if (lastIndex < text.length) {
      frag.appendChild(document.createTextNode(text.slice(lastIndex)));
    }
    return frag;
  }

  // On modifie appendLine pour inclure la détection
  function appendLine(text, options = {}) {
    const el = document.createElement("div");
    el.className = "line";

    if (options.sender) {
      const sender = document.createElement("span");
      sender.className = "sender";
      sender.textContent = `<${options.sender}> `;
      sender.style.color = options.color || "#fff";
      el.appendChild(sender);
    }

    const parsed = detectAndEmbed(text);
    el.appendChild(parsed);

    output.appendChild(el);
    output.scrollTop = output.scrollHeight;
  }
</script>
