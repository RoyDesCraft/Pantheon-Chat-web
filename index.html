<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Pantheon Chat — Terminal iPad</title>
<style>
:root {
  --bg:#000;
  --panel:#061006;
  --text:#9aff8a;
  --muted:#5a8457;
  --accent:#5af;
}
html,body{height:100%;margin:0;font-family:ui-monospace, "Courier New", monospace;background:var(--bg);color:var(--text);}
.wrap{display:flex;flex-direction:column;height:100%;padding:10px;}
.terminal{flex:1;display:flex;flex-direction:column;background:var(--panel);border-radius:6px;padding:10px;overflow:hidden;box-shadow:inset 0 0 40px rgba(0,160,0,0.2);}
.output{flex:1;overflow:auto;padding:8px;font-size:13px;line-height:1.4;}
.input-line{display:flex;gap:6px;align-items:center;margin-top:4px;}
input[type="text"]{flex:1;padding:8px;background:transparent;border:1px solid rgba(90,160,90,0.2);border-radius:4px;color:var(--text);outline:none;font-family:inherit;}
button{padding:6px 10px;border-radius:4px;background:transparent;border:1px solid rgba(90,160,90,0.2);color:var(--text);}
.sender{font-weight:700;margin-right:6px;color:#b6ffb6;}
.msg-img{max-width:100%;border-radius:6px;margin-top:4px;}
.link{color:var(--accent);text-decoration:underline;}
.cursor{display:inline-block;width:8px;height:18px;background:var(--text);vertical-align:middle;animation:blink 1s steps(2,start) infinite;}
@keyframes blink{50%{opacity:0}}
.topbar{display:flex;gap:6px;margin-bottom:4px;}
.mode-pill{padding:4px 6px;border-radius:999px;border:1px solid rgba(90,160,90,0.2);font-size:12px;color:var(--muted);}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="mode-pill" id="mode">Déconnecté</div>
    <div class="mode-pill" id="chatId">—</div>
    <div class="mode-pill" id="nickname">—</div>
    <button id="clearBtn">/clear écran</button>
    <button id="refreshBtn">/refresh</button>
    <input type="file" id="filePicker" accept="image/*" style="display:none"/>
    <button id="uploadBtn">Image</button>
  </div>
  <div class="terminal">
    <div class="output" id="output"></div>
    <div class="input-line">
      <span>&gt;</span>
      <input id="commandInput" type="text" placeholder="Tapez une commande ou message (ex: /help)">
      <span class="cursor" id="cursor"></span>
    </div>
  </div>
</div>

<script>
const API_BASE = 'https://pantheon-chat.onrender.com';
const Output = document.getElementById('output');
const CommandInput = document.getElementById('commandInput');
const ModePill = document.getElementById('mode');
const ChatIdPill = document.getElementById('chatId');
const NickPill = document.getElementById('nickname');
const ClearBtn = document.getElementById('clearBtn');
const RefreshBtn = document.getElementById('refreshBtn');
const FilePicker = document.getElementById('filePicker');
const UploadBtn = document.getElementById('uploadBtn');

let chatId = null;
let nickname = null;
let poller = null;
let lastIndex = 0;

function appendLine(text, options={}) {
  const el = document.createElement('div');
  el.className = 'line';
  if(options.sender){
    const s = document.createElement('span');
    s.className='sender';
    s.textContent = `<${options.sender}> `;
    el.appendChild(s);
  }
  if(options.isImage){
    const a = document.createElement('a');
    a.href = text;
    a.target='_blank';
    a.rel='noopener';
    a.className='link';
    a.textContent = text;
    el.appendChild(a);
    const img = document.createElement('img');
    img.src = text;
    img.className='msg-img';
    el.appendChild(img);
  } else {
    const nodes = linkify(text);
    nodes.forEach(n=>el.appendChild(n));
  }
  Output.appendChild(el);
  Output.scrollTop = Output.scrollHeight;
}

function linkify(text){
  const regex = /(https?:\/\/[^\s]+)/g;
  const parts = [];
  let last=0, m;
  while((m=regex.exec(text))!==null){
    if(m.index>last) parts.push(document.createTextNode(text.slice(last,m.index)));
    const a=document.createElement('a');
    a.href=m[0];
    a.textContent=m[0];
    a.target='_blank';
    a.rel='noopener';
    a.className='link';
    parts.push(a);
    last=m.index+m[0].length;
  }
  if(last<text.length) parts.push(document.createTextNode(text.slice(last)));
  return parts;
}

async function apiPost(path, body){
  const res = await fetch(API_BASE+path,{
    method:'POST',
    headers:{'Content-Type':'application/json; charset=utf-8'},
    body:JSON.stringify(body)
  });
  return res.json();
}

async function apiGet(path){
  const res = await fetch(API_BASE+path);
  return res.json();
}

async function sendMessage(text){
  if(!chatId||!nickname) return;
  if(text.startsWith('/')){
    await handleCommand(text);
    return;
  }
  await apiPost('/send_message',{chat_id:chatId,nickname,text});
}

async function handleCommand(cmd){
  const parts=cmd.split(' ');
  const c=parts[0].toLowerCase();
  if(c==='/help'){
    appendLine("Commandes disponibles: /create [ephemeral|persistent|locked] PSEUDO [MDP] /join CHATID PSEUDO [MDP] /clear /refresh /help",{sender:'SYSTEM'});
  } else if(c==='/clear'){
    Output.innerHTML='';
  } else if(c==='/refresh'){
    await getMessages();
  } else if(c==='/create'){
    const kind=parts[1]||'ephemeral';
    const nick=parts[2]||'Anon';
    const pwd=parts[3]||'';
    const persistent=(kind==='persistent');
    const resp=await apiPost('/create_chat',{password:pwd,persistent:persistent});
    if(resp.chat_id){
      appendLine('Chat créé, ID: '+resp.chat_id,{sender:'SYSTEM'});
      await joinChat(resp.chat_id,nick,pwd);
    } else appendLine('Erreur création',{sender:'SYSTEM'});
  } else if(c==='/join'){
    const id=parts[1];
    const nick=parts[2]||'Anon';
    const pwd=parts[3]||'';
    if(!id){ appendLine('Syntaxe: /join CHATID PSEUDO [MDP]',{sender:'SYSTEM'}); return; }
    await joinChat(id,nick,pwd);
  } else appendLine('Commande inconnue: '+cmd,{sender:'SYSTEM'});
}

async function joinChat(id,nick,pwd){
  const resp=await apiPost('/join',{chat_id:id,nickname:nick,password:pwd});
  if(resp && !resp.error){
    chatId=id;
    nickname=nick;
    ChatIdPill.textContent=id;
    NickPill.textContent=nick;
    ModePill.textContent='Connecté';
    lastIndex=0;
    startPolling();
    appendLine(`Vous avez rejoint le chat ${id}`,{sender:'SYSTEM'});
  } else appendLine('Impossible de rejoindre: '+(resp.error||JSON.stringify(resp)),{sender:'SYSTEM'});
}

async function getMessages(){
  if(!chatId) return;
  const resp=await apiGet(`/get_messages/${chatId}/${lastIndex}`);
  if(resp && resp.messages){
    for(const msg of resp.messages){
      if(msg.type==='image'){
        appendLine(msg.url,{sender:msg.sender,isImage:true});
      } else appendLine(msg.text,{sender:msg.sender});
      lastIndex=Math.max(lastIndex,(msg.index||0)+1);
    }
  }
}

function startPolling(){ if(poller) return; poller=setInterval(getMessages,1200); }
function stopPolling(){ if(!poller) return; clearInterval(poller); poller=null; }

CommandInput.addEventListener('keydown',async e=>{
  if(e.key==='Enter'){
    const v=CommandInput.value.trim();
    if(v){ await sendMessage(v); }
    CommandInput.value='';
  }
});

ClearBtn.addEventListener('click',()=>{ Output.innerHTML=''; });
RefreshBtn.addEventListener('click',getMessages);
UploadBtn.addEventListener('click',()=>FilePicker.click());
FilePicker.addEventListener('change',async ev=>{
  const f=ev.target.files[0];
  if(!f) return;
  const fd=new FormData();
  fd.append('chat_id',chatId);
  fd.append('nickname',nickname);
  fd.append('file',f);
  const res=await fetch(API_BASE+'/upload_image',{method:'POST',body:fd});
  const j=await res.json();
  if(j && j.url) appendLine(j.url,{sender:nickname,isImage:true});
  else appendLine('Erreur upload',{sender:'SYSTEM'});
});

appendLine("Pantheon Terminal initialisé. Tapez /help pour commencer.",{sender:'SYSTEM'});
</script>
</body>
</html>
